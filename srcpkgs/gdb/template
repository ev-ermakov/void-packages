# Template file for 'gdb'
pkgname=gdb
version=10.1
revision=3
build_style=gnu-configure
pycompile_dirs="/usr/share/gdb/python"
configure_args="--disable-nls --with-system-readline
 --with-system-gdbinit=/etc/gdb/gdbinit --with-system-zlib $(vopt_enable gdbserver)
 $(vopt_if static 'CFLAGS=-static CXXFLAGS=-static LDFLAGS=-static')
 $(vopt_with guile) $(vopt_if python --with-python=/usr/bin/python3)
 $(vopt_with debuginfod)"
hostmakedepends="pkg-config texinfo $(vopt_if python python3-devel) $(vopt_if guile guile)"
makedepends="expat-devel ncurses-devel readline-devel zlib-devel $(vopt_if guile guile-devel)
 $(vopt_if python python3-devel) $(vopt_if debuginfod elfutils-devel)"
depends="gdb-common-${version}_${revision}"
checkdepends="dejagnu"
short_desc="GNU Debugger"
maintainer="Anthony Iliopoulos <ailiop@altatus.com>"
license="GPL-3.0-or-later"
homepage="https://www.gnu.org/software/gdb"
distfiles="${GNU_SITE}/gdb/gdb-${version}.tar.xz"
checksum=f82f1eceeec14a3afa2de8d9b0d3c91d5a3820e23e0a01bbb70ef9f0276b62c0
make_check=extended  # Tests take too long, not all of them pass.
python_version=3
ignore_elf_files="
 /usr/share/gdb/guile/gdb/support.go
 /usr/share/gdb/guile/gdb/experimental.go
 /usr/share/gdb/guile/gdb/iterator.go
 /usr/share/gdb/guile/gdb/types.go
 /usr/share/gdb/guile/gdb/printing.go
 /usr/share/gdb/guile/gdb.go"

if [ "${CROSS_BUILD}" ]; then
	# Make python3.x detection work in cross builds
	CFLAGS="-I${XBPS_CROSS_BASE}/${py3_inc}"
	CXXFLAGS="-I${XBPS_CROSS_BASE}/${py3_inc}"
	makedepends+=" libatomic_ops-devel" # guile
fi

# Package build options
build_options="debuginfod gdbserver guile python static"
desc_option_gdbserver="Enable support for building GDB server"
desc_option_debuginfod="Enable support for libdebuginfod"
# Enable gdbserver if !static.
build_options_default="gdbserver python debuginfod"
# Both options cannot be enabled at the same time
vopt_conflict gdbserver static

post_install() {
	# resolve conflicts with binutils
	rm -rf ${DESTDIR}/usr/{include,lib,share/info/bfd.info*}
}

gdb-common_package() {
	short_desc+=" - common files"
	pkg_install() {
		vmove usr/share
	}
}
